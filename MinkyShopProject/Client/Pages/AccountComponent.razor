@page "/account"
@using MinkyShopProject.Data.Models
@inject HttpClient HttpClient;
@inject SweetAlertService Swal;
@inject Blazored.SessionStorage.ISessionStorageService Session
@inject NavigationManager NavigationManager

<main class="bg_gray">

	<div class="container margin_30">
		<div class="page_header">
			<div class="breadcrumbs">
				<ul>
					<li><a href="#">Home</a></li>
					<li><a href="#">Category</a></li>
					<li>Page active</li>
				</ul>
			</div>
			<h1>Sign In or Create an Account</h1>
		</div>
		<!-- /page_header -->
		<div class="row justify-content-center">
			<div class="col-xl-6 col-lg-6 col-md-8">
				<div class="box_account">
					<h3 class="client">Already Client</h3>
					<div class="form_container">
						<div class="form-group">
							<input type="email" class="form-control" @bind="KhachHangDangNhap.Sdt" id="email" placeholder="Số điện thoại">
						</div>
						<div class="form-group">
							<input type="password" class="form-control" @bind="KhachHangDangNhap.MatKhau" id="password_in" placeholder="Mật khẩu">
						</div>
						<div class="clearfix add_bottom_15">
							<div class="float-end"><a id="forgot" href="javascript:void(0);">Lost Password?</a></div>
						</div>
						<div class="text-center"><input type="submit" value="Log In" @onclick="DangNhap" class="btn_1 full-width"></div>
						<div id="forgot_pw">
							<div class="form-group">
								<input type="email" class="form-control" name="email_forgot" id="email_forgot" placeholder="Type your email">
							</div>
							<p>A new password will be sent shortly.</p>
							<div class="text-center"><input type="submit" value="Reset Password" class="btn_1"></div>
						</div>
					</div>
					<!-- /form_container -->
				</div>
				<!-- /row -->
			</div>
			<div class="col-xl-6 col-lg-6 col-md-8">
				<div class="box_account">
					<h3 class="new_client">New Client</h3> <small class="float-right pt-2">* Required Fields</small>
					<div class="form_container">
						<div class="form-group">
							<input type="email" class="form-control" name="email" id="email_2" placeholder="Số điện thoại" @bind="KhachHangDangKy.Sdt">
						</div>
						<div class="form-group">
							<input type="password" class="form-control" id="password_in_2" placeholder="Password*" @bind="KhachHangDangKy.MatKhau">
						</div>
						<!-- /company -->
						<hr>
						<div class="text-center"><input type="submit" value="Register" @onclick="ThemKhachHang" class="btn_1 full-width"></div>
					</div>
					<!-- /form_container -->
				</div>
				<!-- /box_account -->
			</div>
		</div>
		<!-- /row -->
	</div>
	<!-- /container -->
</main>

@code {
	KhachHangThemVaSuaModel KhachHangDangKy = new KhachHangThemVaSuaModel();

	KhachHangThemVaSuaModel KhachHangDangNhap = new KhachHangThemVaSuaModel();

	Uri Url = new Uri("https://localhost:7053/api/khachhang");

	protected async override Task OnInitializedAsync()
	{
		if(await Session.GetItemAsStringAsync("khachHang") != null)
		{
			NavigationManager.NavigateTo("/");
		}
	}

	async Task ThemKhachHang()
	{
		var confirm = await Swal.FireAsync(new SweetAlertOptions { Title = "Bạn Có Chắc Muốn Đăng Ký", ShowConfirmButton = true, ShowCancelButton = true, Icon = SweetAlertIcon.Warning });

		if (string.IsNullOrEmpty(confirm.Value)) return;

		KhachHangDangKy.Ten = "Chưa Có";
		KhachHangDangKy.NgaySinh = new DateTime(2002, 12, 15);

		var s = Url.AddQuery("id", KhachHangDangKy.Id.ToString());
		var result = await HttpClient.PostAsJsonAsync<KhachHangThemVaSuaModel>(Url + "/Create", KhachHangDangKy);

		if (result.IsSuccessStatusCode)
		{
			await Swal.FireAsync("", "Đăng Ký Thành Công", SweetAlertIcon.Success);
		}
		else
		{
			await Swal.FireAsync("", "Đăng Ký Thất Bại", SweetAlertIcon.Error);
		}
	}

	async Task DangNhap()
	{
		var result = await HttpClient.GetFromJsonAsync<ResponseObject<KhachHangModel>>(Url + "/Login?username=" + KhachHangDangNhap.Sdt + "&password=" + KhachHangDangNhap.MatKhau);
		if(result != null)
		{
			await Session.SetItemAsync("khachHang", result.Data);
			NavigationManager.NavigateTo("/admin");
		}
		else
		{
			await Swal.FireAsync("", "Đăng nhập thất bại", SweetAlertIcon.Error);
		}
	}
}
