@page "/variant"

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-12 mb-3">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="example-text-input" class="form-control-label">Sản Phẩm</label>
                                <div class="position-relative">
                                    <input class="form-control" type="text" @bind="SanPham.Ten">
                                </div>
                            </div>
                            <button class="btn btn-sm btn-primary" @onclick="() => { showGiaTri.Add(false); showThuocTinh.Add(false); ModelTemplate.Add(new Data.Models.ThuocTinhModel()); }">Thêm Thuộc Tính</button>
                            <button class="btn btn-sm btn-warning" @onclick="AddAsync">Thêm Sản Phẩm</button>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="example-text-input" class="form-control-label">Loại Sản Phẩm</label>
                                <div class="position-relative">
                                    <input class="form-control" type="text" @onfocus="() => showTheLoai = true" @onfocusout="() => showTheLoai = false" @bind="LoaiHangHoa">
                                    <i class="fa fa-times position-absolute top-50 end-0 translate-middle-y" style="cursor: pointer"></i>
                                </div>
                                <div class="d-flex flex-wrap position-relative pb-2">
                                    <div class="list-group position-absolute w-100 top-0 list" style="z-index: 1">
                                        @if (showTheLoai)
                                        {
                                            foreach (var x in ModelSanPham)
                                            {
                                                <button class="list-group-item list-group-item-action text-sm" aria-current="true" @onmousedown="() => { SanPham.IdTheLoai = x.Id; LoaiHangHoa = x.Ten;  }">
                                                    @x.Ten
                                                </button>
                                                if(x.TheLoais != null)
                                                {
                                                    foreach (var y in x.TheLoais)
                                                    {
                                                        <button class="list-group-item list-group-item-action text-sm" aria-current="true" @onmousedown="() => { SanPham.IdTheLoai = y.Id; LoaiHangHoa = y.Ten;  }">
                                                            - @y.Ten
                                                        </button>
                                                    }
                                                }
                                            }
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        @if (ModelTemplate != null)
                        {
                            @foreach (var x in ModelTemplate.Select((Value, Index) => (Index, Value)))
                            {
                                <div class="col-md-12" @onfocusout="() => { showGiaTri[x.Index] = false; }">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-group mb-0">
                                                <label for="example-text-input" class="form-control-label">Thuộc Tính</label>
                                                <input class="form-control" type="text" @oninput='(ui) => x.Value.Ten = ui.Value?.ToString() ?? "" ' value="@x.Value.Ten" @onfocus="() => { showThuocTinh[x.Index] = true; }"
                                                @onfocusout="() => { showThuocTinh[x.Index] = false; }">
                                            </div>
                                            <div class="d-flex flex-wrap position-relative pb-2">
                                                @if (showThuocTinh[x.Index])
                                                {
                                                    <div class="list-group position-absolute w-100 top-0" style="z-index: 1">
                                                        @if (ModelThuocTinh != null)
                                                        {
                                                            @foreach (var y in ModelThuocTinh)
                                                            {
                                                                <button class="list-group-item list-group-item-action text-sm" aria-current="true" @onmousedown="() => { ModelTemplate[x.Index] = y; ModelThuocTinh.Remove(y); }">
                                                                    @y.Ten
                                                                </button>
                                                            }
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        </div>

                                        <div class="col-5">
                                            <div class="form-group mb-0">
                                                <label for="example-text-input" class="form-control-label">Giá Trị</label>
                                                <div class="position-relative">
                                                    <div class="d-flex flex-wrap position-absolute top-50 end-0 translate-middle-y">
                                                        @if (x.Value.GiaTriTemplates != null)
                                                        {
                                                            @foreach (var y in x.Value.GiaTriTemplates)
                                                            {
                                                                <span class="badge badge-primary me-2 mt-0" style="cursor: pointer" @onmousedown="() => 
                                                                    {  x.Value.GiaTriTemplates.Remove(y); x.Value.GiaTris?.Add(y); }">@y.Ten</span>
                                                            }
                                                        }
                                                    </div>
                                                    <input class="form-control" type="text" @onfocus="() => { showGiaTri[x.Index] = true; }"
                                                   @oninput='(ui) => GiaTri = ui.Value?.ToString() ?? ""'
                                                   @onkeyup='(KeyboardEventArgs ui) => { if(ui.Code == "Enter"){ x.Value.GiaTriTemplates?.Add(new Data.Models.GiaTriModel(){ Ten = GiaTri }); } } '>
                                                </div>
                                            </div>
                                            <div class="d-flex flex-wrap position-relative pb-2">
                                                <div class="list-group position-absolute w-100 top-0" style="z-index: 1">
                                                    @if (showGiaTri[x.Index])
                                                    {
                                                        if (x.Value.GiaTris != null)
                                                        {
                                                            @foreach (var y in x.Value.GiaTris)
                                                            {
                                                                <button class="list-group-item list-group-item-action text-sm" aria-current="true" @onmousedown="() => { x.Value.GiaTriTemplates?.Add(y); x.Value.GiaTris.Remove(y); }">
                                                                    @y.Ten
                                                                </button>
                                                            }
                                                        }
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-1">
                                            <div class="form-group">
                                                <label for="example-text-input" class="form-control-label">&nbsp;</label><br>
                                                <button class="btn btn-danger" @onclick="() => { showThuocTinh.RemoveAt(showThuocTinh.Count - 1); ModelTemplate.Remove(x.Value); }">
                                                    <i class="fa fa-trash" style="cursor: pointer"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>