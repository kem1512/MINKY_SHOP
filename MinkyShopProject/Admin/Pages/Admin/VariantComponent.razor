@page "/admin/variant"

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-12 mb-3">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="example-text-input" class="form-control-label">Sản Phẩm</label>
                                <div class="position-relative">
                                    <input class="form-control" type="text" @bind="SanPham.Ten">
                                </div>
                            </div>
                            <button class="btn btn-sm btn-primary" @onclick="() => {
                                if(ThuocTinhModelsTemplate.Count < 1 || !string.IsNullOrEmpty(ThuocTinhModelsTemplate[ThuocTinhModelsTemplate.Count - 1].Ten)){
                                showGiaTri.Add(false); ThuocTinhs.Add(new ThuocTinh()); ThuocTinhModelsTemplate.Add(new Data.Models.ThuocTinhModel());
                            } }">
                                Thêm Thuộc Tính
                            </button>
                            <button class="btn btn-sm btn-warning" @onclick="AddAsync">Thêm Sản Phẩm</button>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="example-text-input" class="form-control-label">Nhóm Sản Phẩm</label>
                                <div class="position-relative">
                                    <input class="form-control" type="text" @onfocus="() => showNhomSanPham = true" @onfocusout="() => showNhomSanPham = false" @bind="LoaiHangHoa">
                                    <NavLink href="admin/group">
                                        <i class="fa fa-plus position-absolute top-50 end-0 translate-middle-y"></i>
                                    </NavLink>
                                </div>
                                <div class="d-flex flex-wrap position-relative pb-2">
                                    <div class="list-group position-absolute w-100 top-0 list" style="z-index: 1">
                                        @if (showNhomSanPham)
                                        {
                                            if (NhomSanPhamModels?.Data.Content != null)
                                            {
                                                foreach (var x in NhomSanPhamModels.Data.Content.Where(c => c.IdParent != null))
                                                {
                                                    <button class="list-group-item list-group-item-action text-sm" aria-current="true" @onmousedown="() => { SanPham.IdNhomSanPham = x.Id; LoaiHangHoa = x.Ten;  }">
                                                        @x.Ten
                                                    </button>
                                                }
                                            }
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        @if (ThuocTinhModelsTemplate != null)
                        {
                            @foreach (var x in ThuocTinhModelsTemplate.Select((Value, Index) => (Index, Value)))
                            {
                                <div class="col-md-12" @onfocusout="() => { showGiaTri[x.Index] = false; }">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-group mb-0">
                                                <label for="example-text-input" class="form-control-label">Thuộc Tính</label>
                                                <input class="form-control" @attributes='new Dictionary<string, object>(){ { ThuocTinhs[x.Index].Disabled ? "disabled" : "template", "" } }' type="text"
                                               @oninput='(ui) => x.Value.Ten = ui.Value?.ToString() ?? "" ' value="@x.Value.Ten"
                                               @onfocus="() => { ThuocTinhs[x.Index].Show = true; }"
                                               @onfocusout="() => { ThuocTinhs[x.Index].Show = false; }">
                                            </div>
                                            <div class="d-flex flex-wrap position-relative pb-2">
                                                @if (ThuocTinhs[x.Index].Show)
                                                {
                                                    <div class="list-group position-absolute w-100 top-0" style="z-index: 1">
                                                        @if (ThuocTinhModels?.Data.Content != null)
                                                        {
                                                            @foreach (var y in ThuocTinhModels.Data.Content)
                                                            {
                                                                <button class="list-group-item list-group-item-action text-sm"
                                                    @onmousedown="() => { ThuocTinhModelsTemplate[x.Index] = y; ThuocTinhModels.Data.Content.Remove(y); if(y.Id != Guid.Empty){ ThuocTinhs[x.Index].Disabled = true; }; }">
                                                                    @y.Ten
                                                                </button>
                                                            }
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        </div>

                                        <div class="col-5">
                                            <div class="form-group mb-0">
                                                <label for="example-text-input" class="form-control-label">Giá Trị</label>
                                                <div class="position-relative">
                                                    <div class="d-flex flex-wrap position-absolute top-50 end-0 translate-middle-y">
                                                        @if (x.Value.GiaTriTemplates != null)
                                                        {
                                                            @foreach (var y in x.Value.GiaTriTemplates)
                                                            {
                                                                <span class="badge badge-primary me-2 mt-0" style="cursor: pointer"
                                                      @onmousedown="() => {  x.Value.GiaTriTemplates.Remove(y); x.Value.GiaTris?.Add(y); }">@y.Ten</span>
                                                            }
                                                        }
                                                    </div>
                                                    <input class="form-control" type="text" @onfocus="() => { showGiaTri[x.Index] = true; }"
                                                   @oninput='(ui) => GiaTri = ui.Value?.ToString() ?? ""'
                                                   @onkeyup='(KeyboardEventArgs ui) => { if(ui.Code == "Enter"){ x.Value.GiaTriTemplates?.Add(new Data.Models.GiaTriModel(){ Ten = GiaTri }); } } '>
                                                </div>
                                            </div>
                                            <div class="d-flex flex-wrap position-relative pb-2">
                                                <div class="list-group position-absolute w-100 top-0" style="z-index: 1">
                                                    @if (showGiaTri[x.Index])
                                                    {
                                                        if (x.Value.GiaTris != null)
                                                        {
                                                            @foreach (var y in x.Value.GiaTris)
                                                            {
                                                                <button class="list-group-item list-group-item-action text-sm" aria-current="true"
                                                    @onmousedown="() => { x.Value.GiaTriTemplates?.Add(y); x.Value.GiaTris.Remove(y); }
                                                                 ">
                                                                    @y.Ten
                                                                </button>
                                                            }
                                                        }
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-1">
                                            <div class="form-group">
                                                <label for="example-text-input" class="form-control-label">&nbsp;</label><br>
                                                <button class="btn btn-danger"
                                                @onclick="() => { ThuocTinhs.RemoveAt(ThuocTinhs.Count - 1); ThuocTinhModelsTemplate.Remove(x.Value);
                                                    if(x.Value.Id != Guid.Empty){
                                                        ThuocTinhModels?.Data.Content.Add(x.Value); }
                                                    }">
                                                    <i class="fa fa-trash" style="cursor: pointer"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>