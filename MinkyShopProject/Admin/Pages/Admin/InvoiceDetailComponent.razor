@using Data.Models;
@inject HttpClient HttpClient;
@inject SweetAlertService Swal;
@inject NavigationManager NavigationManager;
@inject ISessionStorageService Session;

<div class="container-fluid mt--7" style="overflow-y: auto">
    @if (HoaDon != null)
    {
        <div class="row">
            <div class="col-xl-12 order-xl-1">
                <div class="card shadow-none">
                    <div class="card-header pb-2 pt-3">
                        <div class="row align-items-center">
                            <div class="col-6">
                                <ul class="nav nav-tabs" id="myTab">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-detail" type="button">Thông tin</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-payment" type="button">Lịch sử thanh toán</button>
                                    </li>
                                    @if (HoaDon.LoaiDonHang == (int)MinkyShopProject.Data.Enums.LoaiHoaDon.GiaoHang)
                                    {
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-ship" type="button">Thông tin giao hàng</button>
                                        </li>
                                    }
                                </ul>
                            </div>
                            <div class="col-6 text-end">
                                <button class="btn btn-success me-2" @onclick="async() => await CapNhatHoaDon()">Cập Nhật</button>
                                <button class="btn btn-success me-2" @onclick="async() => { HoaDon.TrangThai = Data.Enums.TrangThaiHoaDon.HoanThanh; if(HoaDon?.NgayHoanThanh == null){ HoaDon.NgayHoanThanh = DateTime.Now; } await CapNhatHoaDon(); }">Hoàn thành</button>
                                <button class="btn btn-success me-2">In</button>
                                <button class="btn btn-danger me-2" @onclick="async() => { HoaDon.TrangThai = Data.Enums.TrangThaiHoaDon.DaHuy; await CapNhatHoaDon(); }">Hủy</button>
                                @if (HoaDon?.TrangThai == MinkyShopProject.Data.Enums.TrangThaiHoaDon.ChoXacNhan && HoaDon?.LoaiDonHang != (int)MinkyShopProject.Data.Enums.LoaiHoaDon.GiaoHang)
                                {
                                    <button class="btn btn-danger me-2" @onclick="async() => { HoaDon.NgayXacNhan = DateTime.Now; await CapNhatHoaDon(); }">Xác Nhận</button>
                                }
                                <button type="button" class="btn btn-danger" data-bs-dismiss="offcanvas">Đóng</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body py-0">
                        <div class="tab-content" id="myTabContent">
                            <div class="tab-pane fade show active" id="tab-detail">
                                <div class="row align-items-center">
                                    <div class="col-4">
                                        <label class="col-form-label text-sm p-0 mb-2 me-3">Mã hóa đơn</label>
                                        <span class="text-bolder text-sm">@HoaDon?.Ma</span>
                                    </div>
                                    <div class="col-4">
                                        <label class="col-form-label text-sm p-0 mb-2 me-3">Trạng thái</label>
                                        @if (HoaDon?.LoaiDonHang == (int)MinkyShopProject.Data.Enums.LoaiHoaDon.GiaoHang)
                                        {
                                            var trangThaiGiaoHang = "";
                                            <span class="text-bolder text-sm text-danger">
                                                @switch (HoaDon.TrangThaiGiaoHang)
                                                {
                                                    case 0:
                                                        trangThaiGiaoHang = "Chờ Xác Nhận";
                                                        break;
                                                    case 1:
                                                        trangThaiGiaoHang = "Chờ Lấy Hàng";
                                                        break;
                                                    case 2:
                                                        trangThaiGiaoHang = "Đang Giao";
                                                        break;
                                                    case 3:
                                                        trangThaiGiaoHang = "Đã Giao";
                                                        break;
                                                    case 4:
                                                        trangThaiGiaoHang = "Đã Hủy";
                                                        break;
                                                    case 5:
                                                        trangThaiGiaoHang = "Chỉ Nhận Một Phần";
                                                        break;
                                                    case 6:
                                                        trangThaiGiaoHang = "Giao Thất Bại";
                                                        break;
                                                    case 7:
                                                        trangThaiGiaoHang = "Không Nghe Máy";
                                                        break;
                                                    default:
                                                        break;
                                                }
                                                @trangThaiGiaoHang
                                            </span>
                                        } else {
                                            <span class="text-bolder text-sm">@HoaDon?.TrangThai</span>
                                        }
                                    </div>
                                    <div class="col-4">
                                        <label class="col-form-label text-sm p-0 mb-2 me-3">Kênh bán</label>
                                        <span class="text-bolder text-sm text-danger">
                                            @{
                                                var loaiDonHang = "";
                                            }
                                            @switch (HoaDon?.LoaiDonHang)
                                            {
                                                case 0:
                                                    loaiDonHang = "Bán Tại Quầy";
                                                    break;
                                                case 1:
                                                    loaiDonHang = "Đặt Hàng";
                                                    break;
                                                case 2:
                                                    loaiDonHang = "Giao Hàng";
                                                    break;
                                                default:
                                                    break;
                                            }
                                            @loaiDonHang
                                        </span>
                                    </div>
                                    <div class="col-4">
                                        <label class="col-form-label text-sm p-0 mb-2 me-3">Thời gian</label>
                                        <span class="text-bolder text-sm">@HoaDon?.NgayTao</span>
                                    </div>
                                    <div class="col-4">
                                        <label class="col-form-label text-sm p-0 mb-2 me-3">Khách hàng</label>
                                        <span class="text-bolder text-sm">@(
                                        HoaDon?.KhachHang?.Ten ?? "Khách Lẻ"
                                        )</span>
                                    </div>
                                    <div class="col-4">
                                        <label class="col-form-label p-0 text-sm mb-2 me-3">Nhân viên</label>
                                        <span class="text-bolder text-sm">@HoaDon?.NhanVien?.Ten</span>
                                    </div>
                                </div>
                                <div class="table-responsive mt-2">
                                    <table class="table table-bordered align-middle text-center">
                                        <thead>
                                            <tr>
                                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Mã hàng</th>
                                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Tên hàng</th>
                                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Số lượng</th>
                                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Đơn giá</th>
                                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Thành tiền</th>
                                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"></th>
                                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @if (HoaDon?.HoaDonChiTiets.Count() > 0)
                                            {
                                                foreach (var x in HoaDon.HoaDonChiTiets.Where(c => c.SoLuong > 0).Select((Value, Index) => (Index, Value)))
                                                {
                                                    <tr>
                                                        <td>
                                                            <span class="text-secondary text-xs font-weight-bold">@x.Value.BienThe?.Sku</span>
                                                        </td>
                                                        <td>
                                                            <span class="text-secondary text-xs font-weight-bold">@x.Value.BienThe?.SanPham?.Ten (@string.Join(" ", x.Value.BienThe?.BienTheChiTiets?.Select(c => c.GiaTri?.Ten)))</span>
                                                        </td>
                                                        <td class="w-10">
                                                            <input class="text-secondary text-xs font-weight-bold form-control text-center border-0" value="@x.Value.SoLuong" @oninput='e => { x.Value.SoLuong = int.Parse(e.Value?.ToString() ?? ""); }' @onchange="async() => await CapNhatTongTien()">
                                                        </td>
                                                        <td class="align-middle text-center text-sm">
                                                            <span class="text-secondary text-xs font-weight-bold">@Helper.FormatMoney(x.Value.DonGia)</span>
                                                        </td>
                                                        <td class="align-middle text-center text-sm">
                                                            <span class="text-secondary text-xs font-weight-bold">@Helper.FormatMoney(x.Value.DonGia * x.Value.SoLuong)</span>
                                                        </td>
                                                        <td class="align-middle text-center text-sm">
                                                            <div class="form-check d-flex justify-content-center">
                                                                <input class="form-check-input" type="checkbox" value="" id="fcustomCheck1" 
                                                                @attributes='x.Value.TrangThai == 0 ? new Dictionary<string, object>(){ { "checked", "" } } : null'
                                                                @onchange='async() => await ThayDoiTrangThaiSanPham(x.Index)'
                                                                >
                                                            </div>
                                                        </td>
                                                        <td class="align-middle text-center text-sm">
                                                            <button class="btn btn-xs mb-0" 
                                                            @onclick='async() => { 
                                                                if(HoaDon.HoaDonChiTiets.Count <= 0){
                                                                    await Swal.FireAsync("", "Không Thể Xóa Hết Sản Phẩm", SweetAlertIcon.Error);
                                                                }else{
                                                                    HoaDon.HoaDonChiTiets.Remove(x.Value); 
                                                                    await CapNhatTongTien();
                                                                }
                                                            }'
                                                                ><i class="fa fa-trash text-danger"></i></button>
                                                        </td>
                                                    </tr>
                                                }
                                            }
                                            else
                                            {
                                                <tr>
                                                    <td colspan="6" class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Không Có Dữ Liệu</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                                <div class="row align-items-center text-end mt-2">
                                    <div class="col-8 d-flex">
                                        <input class="form-control w-25 me-2" @bind="Ma"/>
                                        <button class="btn btn-primary mb-0 me-2" @onclick="() => ThemSanPham()">Thêm SP</button>
                                        <input placeholder="Ghi Chú" class="form-control w-50" @bind="HoaDon.GhiChu"/>
                                    </div>
                                    <div class="col-4">
                                        <label class="col-form-label text-sm me-3 p-0 mb-2">Số lượng hàng hóa</label>
                                        <span class="text-bolder text-sm">@HoaDon?.HoaDonChiTiets.Count()</span>
                                    </div>
                                    <div class="col-12">
                                        <label class="col-form-label text-sm me-3 p-0 mb-2">Tổng tiền hàng</label>
                                        <span class="text-bolder text-sm">@(Helper.FormatMoney(HoaDon?.VoucherLogs != null && HoaDon.VoucherLogs.Any() ? HoaDon.VoucherLogs[0].TienTruocKhiGiam : HoaDon?.TongTien))</span>
                                        @if(HoaDon?.LoaiDonHang == 2)
                                        {
                                            <span class="text-bolder text-sm">( @Helper.FormatMoney(HoaDon?.TienShip) tiền ship)</span>
                                        }
                                    </div>
                                    <div class="col-6 text-start">
                                        @if (HoaDon.NgayCapNhat != null)
                                        {
                                            <span class="text-bolder text-sm">Ngày Cập Nhật : @HoaDon.NgayCapNhat</span>
                                        }
                                    </div>
                                    <div class="col-6">
                                        <label class="col-form-label text-sm me-3 p-0 mb-2">Giảm giá hóa đơn</label>
                                        <span class="text-bolder text-sm">@(
                                        HoaDon?.VoucherLogs != null && HoaDon.VoucherLogs.Any() ? Helper.FormatMoney(HoaDon?.VoucherLogs?[0].SoTienGiam) : 0
                                        )</span>
                                    </div>
                                    <div class="col-6 text-start">
                                        @if (HoaDon.NgayHoanThanh != null)
                                        {
                                            <span class="text-bolder text-sm">Ngày Hoàn Thành : @HoaDon.NgayHoanThanh</span>
                                        }
                                    </div>
                                    <div class="col-6">
                                        <label class="col-form-label text-sm me-3 p-0 mb-2">Khách cần trả</label>
                                        <span class="text-bolder text-sm">@( Helper.FormatMoney(HoaDon?.VoucherLogs != null && HoaDon.VoucherLogs.Any() ? HoaDon.VoucherLogs[0].TienSauKhiGiam : HoaDon?.TongTien))</span>
                                    </div>
                                    <div class="col-12">
                                        <label class="col-form-label text-sm me-3 p-0 mb-2">Khách đã trả</label>
                                        <span class="text-bolder text-sm">@Helper.FormatMoney(HoaDon?.HinhThucThanhToans.Sum(c => c.TongTienThanhToan))</span>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="tab-payment">
                                @if (HoaDon?.HinhThucThanhToans.Sum(c => c.TongTienThanhToan) > 0) {
                                    <div class="table-responsive my-2">
                                        <table class="table table-bordered align-middle text-center">
                                            <thead>
                                                <tr>
                                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Mã phiếu</th>
                                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Thời gian</th>
                                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Nhân viên</th>
                                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Phương thức</th>
                                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Tiền thanh toán</th>
                                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Trạng thái</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @if (HoaDon != null)
                                                {
                                                    @foreach (var x in HoaDon.HinhThucThanhToans.Select((Value, Index) => (Index, Value)))
                                                    {
                                                        @if (x.Value.TongTienThanhToan > 0)
                                                        {
                                                            <tr>
                                                                <td>
                                                                    <span class="text-secondary text-xs font-weight-bold">@x.Index</span>
                                                                </td>
                                                                <td style="width: 20%">
                                                                    <span class="text-secondary text-xs font-weight-bold">@x.Value.NgayTao</span>
                                                                </td>
                                                                <td style="width: 20%">
                                                                    <span class="text-secondary text-xs font-weight-bold">Hải Đăng</span>
                                                                </td>
                                                                <td class="align-middle text-center text-sm">
                                                                    <span class="text-secondary text-xs font-weight-bold">
                                                                        @{
                                                                            var kieuThanhToan = "";
                                                                            switch (x.Value.KieuThanhToan)
                                                                            {
                                                                                case 0:
                                                                                    kieuThanhToan = "Tiền mặt";
                                                                                    break;
                                                                                case 1:
                                                                                    kieuThanhToan = "Chuyển khoản";
                                                                                    break;
                                                                                case 2:
                                                                                    kieuThanhToan = "Cọc";
                                                                                    break;
                                                                                default:
                                                                                    break;
                                                                            }
                                                                        }
                                                                        @kieuThanhToan
                                                                    </span>
                                                                </td>
                                                                <td class="align-middle text-center text-sm">
                                                                    <span class="text-secondary text-xs font-weight-bold">@Helper.FormatMoney(x.Value.TongTienThanhToan)</span>
                                                                </td>
                                                                <td class="align-middle text-center text-sm">
                                                                    <span class="text-secondary text-xs font-weight-bold">@(
                                                    x.Value.TongTienThanhToan <= 0 ? "Chưa thanh toán" : "Đã thanh toán"
                                                    )</span>
                                                                </td>
                                                            </tr>
                                                        }
                                                    }
                                                    <tr>
                                                        <td colspan="6" class="py-2">
                                                            <div class="d-flex justify-content-around">
                                                                <span class="text-secondary text-xs font-weight-bold">Khách Cần Trả : @Helper.FormatMoney(HoaDon.TongTien)</span>
                                                                <span class="text-secondary text-xs font-weight-bold">Khách Đã Trả @Helper.FormatMoney(HoaDon.HinhThucThanhToans.Sum(c => c.TongTienThanhToan))</span>
                                                                <span class="text-secondary text-xs font-weight-bold">Tiền Thừa Trả Khách @Helper.FormatMoney(HoaDon.HinhThucThanhToans.Sum(c => c.TongTienThanhToan) - HoaDon.TongTien)</span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <div class="table-responsive my-2">
                                        <table class="table table-bordered align-middle text-center">
                                            <thead>
                                                <tr>
                                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Mã phiếu</th>
                                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Thời gian</th>
                                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Nhân viên</th>
                                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Phương thức</th>
                                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Tiền thanh toán</th>
                                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Trạng thái</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @if (HoaDon != null)
                                                {
                                                    <tr>
                                                        <td colspan="6" class="py-2">
                                                            <div class="d-flex justify-content-around">
                                                                <span class="text-secondary text-xs font-weight-bold">Khách Cần Trả : @Helper.FormatMoney(HoaDon.TongTien)</span>
                                                                <span class="text-secondary text-xs font-weight-bold">Khách Đã Trả @Helper.FormatMoney(HoaDon.HinhThucThanhToans.Sum(c => c.TongTienThanhToan))</span>
                                                                <span class="text-secondary text-xs font-weight-bold">Tiền Thừa Trả Khách @Helper.FormatMoney(HoaDon.HinhThucThanhToans.Sum(c => c.TongTienThanhToan) - HoaDon.TongTien)</span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                <div class="d-flex flex-wrap justify-content-end">
                                    <button class="btn btn-primary btn-sm mb-0 me-2" @onclick="() => ThemHinhThucThanhToan(0)">Tiền Mặt</button>
                                    <button class="btn btn-success btn-sm mb-0 me-2" @onclick="() => ThemHinhThucThanhToan(1)">Chuyển Khoản</button>
                                    <input class="form-control w-25 me-2" value="@string.Format("{0:0,0}", soTienThanhToan)" @oninput='e => soTienThanhToan = float.Parse(e.Value?.ToString() ?? "")'>
                                    <button class="btn btn-danger btn-sm mb-0 me-2" @onclick="() => HoaDon.HinhThucThanhToans = new List<HinhThucThanhToanModel>()">Hủy</button>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="tab-ship">
                                <div class="d-flex flex-wrap mt-3 justify-content-around text-center">
                                    <div class="d-flex flex-column">
                                        <button class="btn @(HoaDon?.NgayXacNhan != null ? "btn-success" : "")" @onclick="async() => { if(HoaDon?.NgayXacNhan == null) HoaDon.NgayXacNhan = DateTime.Now; HoaDon.TrangThaiGiaoHang = (int) MinkyShopProject.Data.Enums.TrangThaiGiaoHang.ChoLayHang; await CapNhatHoaDon(); }"><i class="ni ni-single-copy-04 p-4"></i></button>
                                        @if (HoaDon?.NgayXacNhan != null)
                                        {
                                            <span class="text-bold">Đã Xác nhận</span>
                                            <p>@HoaDon?.NgayXacNhan</p>
                                        }
                                        else
                                        {
                                            <span class="text-bold">Xác nhận</span>
                                        }
                                    </div>
                                    <div class="d-flex flex-column">
                                        <button class="btn me-2 @(HoaDon?.NgayLayHang != null ? "btn-success disabled" : "")" @onclick='async() => { 
                                            if(HoaDon?.NgayXacNhan != null){
                                                HoaDon.NgayLayHang = DateTime.Now;
                                                HoaDon.TrangThaiGiaoHang = (int)MinkyShopProject.Data.Enums.TrangThaiGiaoHang.ChoLayHang;
                                                await CapNhatHoaDon();
                                            }else{
                                                await Swal.FireAsync("", "Đơn phải xác nhận trước khi chờ lấy hàng", SweetAlertIcon.Error);
                                            }
                                        }'><i class="fa fa-cart-shopping-fast p-4"></i></button>
                                        <span class="text-bold">Chờ lấy hàng</span>
                                    </div>
                                    <div class="d-flex flex-column">
                                        <button class="btn me-2 @(HoaDon?.NgayGiaoHang != null ? "btn-success disabled" : "")" @onclick='async() => { 
                                            if(HoaDon?.NgayLayHang != null){
                                                HoaDon.NgayGiaoHang = DateTime.Now; HoaDon.TrangThaiGiaoHang = (int)MinkyShopProject.Data.Enums.TrangThaiGiaoHang.DangGiao;
                                                await CapNhatHoaDon();
                                            } else{
                                                 await Swal.FireAsync("", "Chưa lấy hàng không thể giao", SweetAlertIcon.Error);
                                            }
                                        }'><i class="ni ni-user-run p-4"></i></button>
                                        <span class="text-bold">Đang giao</span>
                                        <p>@HoaDon?.NgayGiaoHang</p>
                                    </div>
                                    <div class="d-flex flex-column">
                                        <button class="btn me-2 @(HoaDon?.TrangThaiGiaoHang == 3 ? "btn-success disabled" : "")" @onclick="async() => { CapNhatTrangThai(3);  }"><i class="ni ni-bag-17 p-4"></i></button>
                                        <span class="text-bold">Đã nhận hàng</span>
                                        <p>@(HoaDon?.TrangThaiGiaoHang == 3 ? HoaDon?.NgayNhan : "")</p>
                                    </div>
                                    <div class="d-flex flex-column">
                                        <button class="btn me-2 @(HoaDon?.TrangThaiGiaoHang == 7 ? "btn-success disabled" : "")" @onclick="async() => { CapNhatTrangThai(7); }"><i class="ni ni-bag-17 p-4"></i></button>
                                        <span class="text-bold">Không Nghe Máy</span>
                                    </div>
                                    <div class="d-flex flex-column">
                                        <button class="btn me-2 @(HoaDon?.TrangThaiGiaoHang == 5 ? "btn-success disabled" : "")" @onclick="async() => { CapNhatTrangThai(5); }"><i class="ni ni-bag-17 p-4"></i></button>
                                        <span class="text-bold">Chỉ Nhận Một Phần</span>
                                        <p>@(HoaDon?.TrangThaiGiaoHang == 5 ? HoaDon?.NgayNhan : "")</p>
                                    </div>
                                </div>
                                <div class="row align-items-center text-end mt-2">
                                    <div class="col-12">
                                        <label class="col-form-label text-sm me-2 p-0 mb-2">Người nhận</label>
                                        <span class="text-bolder text-sm">@HoaDon?.TenNguoiNhan</span>
                                    </div>
                                    <div class="col-6 text-start d-flex align-items-center">
                                        <label class="col-form-label text-sm me-2 p-0">Ghi Chú</label>
                                        <input class="form-control w-50" @bind="@HoaDon.GhiChuGiaoHang" />
                                    </div>
                                    <div class="col-6">
                                        <label class="col-form-label text-sm me-2 p-0 mb-2">Số điện thoại</label>
                                        <span class="text-bolder text-sm">@HoaDon?.Sdt</span>
                                    </div>
                                    <div class="col-12">
                                        <label class="col-form-label text-sm me-2 p-0 mb-2">Địa chỉ</label>
                                        <span class="text-bolder text-sm">@HoaDon?.DiaChi</span>
                                    </div>
                                    <div class="col-12">
                                        <label class="col-form-label text-sm  me-2 p-0 mb-2">Tiền ship</label>
                                        <span class="text-bolder text-sm">@Helper.FormatMoney(HoaDon?.TienShip)</span>
                                    </div>
                                    <div class="col-12">
                                        <label class="col-form-label text-sm  me-2 p-0 mb-2">Khách phải trả</label>
                                        <span class="text-bolder text-sm">@Helper.FormatMoney(HoaDon?.TongTien + HoaDon?.TienShip) (@Helper.FormatMoney(HoaDon?.TienShip) tiền ship)</span>
                                    </div>
                                    <div class="col-12">
                                        <label class="col-form-label text-sm  me-2 p-0 mb-2">Trạng thái</label>
                                        <span class="text-bolder text-sm">@(HoaDon?.HinhThucThanhToans.Sum(c => c.TongTienThanhToan) + HoaDon?.TienShip < HoaDon?.TongTien ? "Chưa thanh toán đủ" : "Đã thanh toán")</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {

    Uri Url = new Uri("https://localhost:7053/api/hoadon");

    [Parameter]
    public HoaDonModel? HoaDon { get; set; }

    string Ma = "";

    List<HinhThucThanhToanModel> HinhThucThanhToans = new List<HinhThucThanhToanModel>();

    async Task UpdateSale()
    {
        if(HoaDon != null)
        {
            if(HoaDon.TrangThai != Data.Enums.TrangThaiHoaDon.HoanThanh)
            {
                List<HoaDonModel> HoaDons = await Session.GetItemAsync<List<HoaDonModel>>("cart") ?? new List<HoaDonModel>();
                HoaDons.Add(HoaDon);
                await Session.SetItemAsync("cart", HoaDons);
                NavigationManager.NavigateTo("sale");
            }
            else
            {
                await Swal.FireAsync("Thông báo", "Hóa Đơn Đã Hoàn Thanh Không Thể Sửa", SweetAlertIcon.Error);
            }
        }
    }

    async Task Cancel()
    {
        if(HoaDon != null && HoaDon.TrangThai != Data.Enums.TrangThaiHoaDon.HoanThanh)
        {
            HoaDon.TrangThai = Data.Enums.TrangThaiHoaDon.DaHuy;
            HoaDon.NhanVien = null;
            var status = await HttpClient.PutAsJsonAsync<HoaDonModel>(Url.AddQuery("id", HoaDon.Id.ToString()), HoaDon);
            if (status.IsSuccessStatusCode)
            {
                await Swal.FireAsync("Thông báo", "Hủy Thành Công", SweetAlertIcon.Success);
                return;
            }
        }
        else
        {
            await Swal.FireAsync("Thông báo", "Không Thể Hủy Hóa Đơn Đã Hoàn Thành", SweetAlertIcon.Error);
        }
    }

    async Task CapNhatHoaDon()
    {
        var confirm = await Swal.FireAsync(new SweetAlertOptions { Title = "Bạn Có Chắc Muốn Cập Nhật", ShowConfirmButton = true, ShowCancelButton = true, Icon = SweetAlertIcon.Warning });

        if (string.IsNullOrEmpty(confirm.Value)) return;

        HoaDon.NgayCapNhat = DateTime.Now;
        var status = await HttpClient.PutAsJsonAsync<HoaDonModel>(Url.AddQuery("id", HoaDon.Id.ToString()), HoaDon);
        if (status.IsSuccessStatusCode)
        {
            await Swal.FireAsync("", "Cập Nhật Thành Công", SweetAlertIcon.Success);
        }
        else
        {

            await Swal.FireAsync("", "Cập Nhật Thất Bại", SweetAlertIcon.Error);
        }
    }

    async Task ThemSanPham()
    {
        var bienThe = await HttpClient.GetFromJsonAsync<ResponseObject<BienTheModel>>("https://localhost:7053/api/bienthe/search/" + Ma);
        if (bienThe != null)
        {
            var hoaDonChiTiet = HoaDon?.HoaDonChiTiets.FirstOrDefault(c => c.IdBienThe == bienThe.Data.Id);
            if (hoaDonChiTiet != null)
            {
                hoaDonChiTiet.SoLuong += 1;
            }
            else
            {
                HoaDon?.HoaDonChiTiets.Add(new HoaDonChiTietModel() { DonGia = bienThe.Data.GiaBan, IdBienThe = bienThe.Data.Id, SoLuong = 1, BienThe = bienThe.Data });
            }
            HoaDon.TongTien = HoaDon.HoaDonChiTiets.Sum(c => c.SoLuong * c.DonGia) + HoaDon.TienShip;
        }
    }

    float soTienThanhToan = 0;

    async Task CapNhatTrangThai(int val)
    {
        if (HoaDon?.TrangThaiGiaoHang == 2 || HoaDon?.TrangThaiGiaoHang == 7)
        {
            switch (val)
            {
                case 3:
                    if (HoaDon?.HinhThucThanhToans.Sum(c => c.TongTienThanhToan) < HoaDon?.TongTien)
                    {
                        await Swal.FireAsync("", "Phải Thanh Toán Đủ Trước Khi Nhận Hàng", SweetAlertIcon.Error);
                        return;
                    }

                    HoaDon.NgayNhan = DateTime.Now; HoaDon.TrangThaiGiaoHang = (int)MinkyShopProject.Data.Enums.TrangThaiGiaoHang.DaGiao;
                    if (HoaDon.NgayHoanThanh == null) { HoaDon.NgayHoanThanh = DateTime.Now; }
                    await CapNhatHoaDon();
                    break;
                case 7:
                    HoaDon.TrangThaiGiaoHang = (int)MinkyShopProject.Data.Enums.TrangThaiGiaoHang.KhachKhongNgheMay; await CapNhatHoaDon();
                    break;
                case 5:
                    if (HoaDon?.HinhThucThanhToans.Sum(c => c.TongTienThanhToan) < HoaDon?.TongTien)
                    {
                        await Swal.FireAsync("", "Phải Thanh Toán Đủ Trước Khi Nhận Hàng", SweetAlertIcon.Error);
                        return;
                    }
                    HoaDon.NgayNhan = DateTime.Now; HoaDon.TrangThaiGiaoHang = (int)MinkyShopProject.Data.Enums.TrangThaiGiaoHang.DaGiaoNhungKhachChiNhanMotPhanHang;
                    if (HoaDon.NgayHoanThanh == null) { HoaDon.NgayHoanThanh = DateTime.Now; }
                    await CapNhatHoaDon();
                    break;
                default:
                    break;
            }
        }
        else
        {
            await Swal.FireAsync("","Chỉ Đơn Đang Giao Mới Có Thể Thay Đổi", SweetAlertIcon.Error);
        }
    }

    public async Task ThemHinhThucThanhToan(int kieuThanhToan)
    {
        if(HoaDon != null)
        {
            var hinhThucThanhToan = HoaDon.HinhThucThanhToans.FirstOrDefault(c => c.KieuThanhToan == kieuThanhToan);
            if (hinhThucThanhToan == null)
            {
                HoaDon.HinhThucThanhToans.Add(new HinhThucThanhToanModel() { KieuThanhToan = kieuThanhToan, TongTienThanhToan = soTienThanhToan, NgayTao = DateTime.Now });
            }
            else
            {
                hinhThucThanhToan.TongTienThanhToan += soTienThanhToan;
                hinhThucThanhToan.NgayTao = DateTime.Now;
            }
            var voucher = HoaDon.VoucherLogs?[0];
            HoaDon.TongTien = (HoaDon.HoaDonChiTiets.Sum(c => c.DonGia * c.SoLuong) + HoaDon.TienShip) - (voucher != null ? voucher.SoTienGiam : 0);
            soTienThanhToan = 0;
        }
    }

    async Task ThayDoiTrangThaiSanPham(int index)
    {
        if (HoaDon?.TrangThaiGiaoHang == 5)
        {
            var hoaDonChiTiet = HoaDon?.HoaDonChiTiets[index];
            if (hoaDonChiTiet != null)
            {
                hoaDonChiTiet.TrangThai = hoaDonChiTiet.TrangThai == 1 ? 0 : 1;
            }
            await CapNhatHoaDon();
        }
        else
        {
            await Swal.FireAsync("", "Chỉ Đơn Có Trạng Thái Nhận Một Phần Mới Có Thể Sửa", SweetAlertIcon.Error);
        }
    }

    async Task CapNhatTongTien()
    {
        if(HoaDon != null)
        {
            var voucher = HoaDon?.VoucherLogs;
            if(voucher != null && voucher.Any())
            {
                HoaDon.TongTien = (HoaDon.HoaDonChiTiets.Sum(c => c.DonGia * c.SoLuong) + HoaDon.TienShip) - voucher[0].SoTienGiam;
            }
            else
            {
                HoaDon.TongTien = (HoaDon.HoaDonChiTiets.Sum(c => c.DonGia * c.SoLuong) + HoaDon.TienShip);
            }
        }
    }
}