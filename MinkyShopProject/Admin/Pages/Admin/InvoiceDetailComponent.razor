@using Data.Models;
@inject HttpClient HttpClient;
@inject SweetAlertService Swal;
@inject NavigationManager NavigationManager;
@inject ISessionStorageService Session;

<div class="container-fluid mt--7" style="overflow-y: auto">
    @if(HoaDon != null)
    {
        <div class="row">
            <div class="col-xl-12 order-xl-1">
                <div class="card shadow-none">
                    <div class="card-header pb-2 pt-3">
                        <div class="row align-items-center">
                            <div class="col-4">
                                <strong class="mb-0">&nbsp;</strong>
                            </div>
                            <div class="col-8">
                                <ul class="nav nav-tabs" id="myTab">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link text-dark active" id="home-tab" data-bs-toggle="tab" data-bs-target="#tab-detail" type="button">Thông tin</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link text-dark" id="home-tab" data-bs-toggle="tab" data-bs-target="#tab-payment" type="button">Lịch sử thanh toán</button>
                                    </li>
                                    @if(HoaDon.LoaiDonHang == 1)
                                    {
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link text-dark" id="home-tab" data-bs-toggle="tab" data-bs-target="#tab-ship" type="button">Thông tin giao hàng</button>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body py-0">
                        <div class="tab-content" id="myTabContent">
                            <div class="tab-pane fade show active" id="tab-detail">
                                <div class="row align-items-center">
                                    <div class="col-4">
                                        <label class="col-form-label text-sm p-0 mb-2 me-3">Mã hóa đơn</label>
                                        <span class="text-bolder text-sm">@HoaDon?.Ma</span>
                                    </div>
                                    <div class="col-4">
                                        <label class="col-form-label text-sm p-0 mb-2 me-3">Trạng thái</label>
                                        <span class="text-bolder text-sm">@HoaDon?.TrangThai</span>
                                    </div>
                                    <div class="col-4">
                                        <label class="col-form-label text-sm p-0 mb-2 me-3">Kênh bán</label>
                                        <span class="text-bolder text-sm">@(HoaDon?.LoaiDonHang == 0 ? "Trực tiếp" : "Online")</span>
                                    </div>
                                    <div class="col-4">
                                        <label class="col-form-label text-sm p-0 mb-2 me-3">Thời gian</label>
                                        <span class="text-bolder text-sm">@HoaDon?.NgayTao</span>
                                    </div>
                                    <div class="col-4">
                                        <label class="col-form-label text-sm p-0 mb-2 me-3">Khách hàng</label>
                                        <span class="text-bolder text-sm">@(HoaDon?.KhachHang?.Ten ?? "Khách Lẻ")</span>
                                    </div>
                                    <div class="col-4">
                                        <label class="col-form-label p-0 text-sm mb-2 me-3">Nhân viên</label>
                                        <span class="text-bolder text-sm">@HoaDon?.NhanVien?.Ten</span>
                                    </div>
                                </div>
                                <div class="table-responsive mt-2">
                                    <table class="table table-bordered align-middle text-center">
                                        <thead>
                                            <tr>
                                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Mã hàng</th>
                                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Tên hàng</th>
                                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Số lượng</th>
                                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Đơn giá</th>
                                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Giá bán</th>
                                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Thành tiền</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @if (HoaDon?.HoaDonChiTiets.Count() > 0)
                                            {
                                                foreach (var x in HoaDon.HoaDonChiTiets.Select((Value, Index) => (Index, Value)))
                                                {
                                                    <tr>
                                                        <td>
                                                            <span class="text-secondary text-xs font-weight-bold">@x.Value.BienThe?.Sku</span>
                                                        </td>
                                                        <td style="width: 20%">
                                                            <span class="text-secondary text-xs font-weight-bold">@x.Value.BienThe?.SanPham?.Ten (@string.Join(" ", x.Value.BienThe?.BienTheChiTiets?.Select(c => c.GiaTri?.Ten)))</span>
                                                        </td>
                                                        <td style="width: 20%">
                                                            <span class="text-secondary text-xs font-weight-bold">@x.Value.SoLuong</span>
                                                        </td>
                                                        <td class="align-middle text-center text-sm">
                                                            <span class="text-secondary text-xs font-weight-bold">@Helper.FormatMoney(x.Value.DonGia)</span>
                                                        </td>
                                                        <td class="align-middle text-center text-sm">
                                                            <span class="text-secondary text-xs font-weight-bold">@Helper.FormatMoney(x.Value.BienThe?.GiaBan)</span>
                                                        </td>
                                                        <td class="align-middle text-center text-sm">
                                                            <span class="text-secondary text-xs font-weight-bold">@Helper.FormatMoney(x.Value.DonGia * x.Value.SoLuong)</span>
                                                        </td>
                                                    </tr>
                                                }
                                            }
                                            else
                                            {
                                                <tr>
                                                    <td colspan="6" class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Không Có Dữ Liệu</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                                <div class="row align-items-center text-end mt-2">
                                    <div class="col-12">
                                        <label class="col-form-label text-sm me-3 p-0 mb-2">Số lượng hàng hóa</label>
                                        <span class="text-bolder text-sm">@HoaDon?.HoaDonChiTiets.Count()</span>
                                    </div>
                                    <div class="col-12">
                                        <label class="col-form-label text-sm me-3 p-0 mb-2">Tổng tiền hàng</label>
                                        <span class="text-bolder text-sm">@(HoaDon?.VoucherLogs != null && HoaDon.VoucherLogs.Any() ? Helper.FormatMoney(HoaDon?.VoucherLogs[0].TienTruocKhiGiam) : Helper.FormatMoney(HoaDon?.TongTien))</span>
                                    </div>
                                    <div class="col-12">
                                        <label class="col-form-label text-sm me-3 p-0 mb-2">Giảm giá hóa đơn</label>
                                        <span class="text-bolder text-sm">@(HoaDon?.VoucherLogs != null && HoaDon.VoucherLogs.Any() ? Helper.FormatMoney(HoaDon?.VoucherLogs?[0].SoTienGiam) : 0)</span>
                                    </div>
                                    <div class="col-12">
                                        <label class="col-form-label text-sm me-3 p-0 mb-2">Khách cần trả</label>
                                        <span class="text-bolder text-sm">@Helper.FormatMoney(HoaDon?.TongTien)</span>
                                    </div>
                                    <div class="col-12">
                                        <label class="col-form-label text-sm me-3 p-0 mb-2">Khách đã trả</label>
                                        <span class="text-bolder text-sm">@Helper.FormatMoney(HoaDon?.HinhThucThanhToans.Sum(c => c.TongTienThanhToan))</span>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="d-flex flex-wrap">
                                        <button class="btn btn-success me-2" @onclick="UpdateSale">Cập nhật</button>
                                        <button class="btn btn-success me-2">In</button>
                                        <button class="btn btn-danger me-2" @onclick="Cancel">Hủy đơn hàng</button>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="tab-payment">
                                <div class="table-responsive mt-2">
                                    <table class="table table-bordered align-middle text-center">
                                        <thead>
                                            <tr>
                                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Mã phiếu</th>
                                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Thời gian</th>
                                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Nhân viên</th>
                                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Phương thức</th>
                                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Tiền thanh toán</th>
                                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Trạng thái</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @if (HoaDon != null)
                                            {
                                                @foreach (var x in HoaDon.HinhThucThanhToans.Select((Value, Index) => (Index, Value)))
                                                {
                                                    <tr>
                                                        <td>
                                                            <span class="text-secondary text-xs font-weight-bold">@x.Index</span>
                                                        </td>
                                                        <td style="width: 20%">
                                                            <span class="text-secondary text-xs font-weight-bold">@x.Value.NgayTao</span>
                                                        </td>
                                                        <td style="width: 20%">
                                                            <span class="text-secondary text-xs font-weight-bold">Hải Đăng</span>
                                                        </td>
                                                        <td class="align-middle text-center text-sm">
                                                            <span class="text-secondary text-xs font-weight-bold">@{
                                                                    var kieuThanhToan = "";
                                                                    switch (x.Value.KieuThanhToan)
                                                                    {
                                                                        case 0:
                                                                            kieuThanhToan = "Tiền mặt";
                                                                            break;
                                                                        case 1:
                                                                            kieuThanhToan = "Chuyển khoản";
                                                                            break;
                                                                        case 2:
                                                                            kieuThanhToan = "Cọc";
                                                                            break;
                                                                        default:
                                                                            break;
                                                                    }
                                                                }
                                                                @kieuThanhToan
                                                       </span>
                                                    </td>
                                                        <td class="align-middle text-center text-sm">
                                                            <span class="text-secondary text-xs font-weight-bold">@Helper.FormatMoney(x.Value.TongTienThanhToan)</span>
                                                        </td>
                                                        <td class="align-middle text-center text-sm">
                                                            <span class="text-secondary text-xs font-weight-bold">@(x.Value.TongTienThanhToan <= 0 ? "Chưa thanh toán" : "Đã thanh toán")</span>
                                                        </td>
                                                    </tr>
                                                }
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                                @if (HoaDon?.LoaiDonHang == 1)
                                {
                                    <div class="tab-pane fade" id="tab-ship">
                                        <div class="d-flex flex-wrap mt-3 justify-content-around text-center">
                                            <div class="d-flex flex-column">
                                                <button class="btn btn-success"><i class="ni ni-single-copy-04 p-4"></i></button>
                                                <span class="text-bold">Đã xác nhận</span>
                                                <p>@HoaDon?.NgayTao</p>
                                            </div>
                                            <div class="d-flex flex-column">
                                                <button class="btn me-2 @(HoaDon?.NgayGiaoHang != null ? "btn-success disabled" : "")" @onclick="async() => await UpdateAsync(1)"><i class="ni ni-user-run p-4"></i></button>
                                                <span class="text-bold">Đang giao</span>
                                                <p>@HoaDon?.NgayGiaoHang</p>
                                            </div>
                                            <div class="d-flex flex-column">
                                                <button class="btn me-2 @(HoaDon?.NgayThanhToan != null ? "btn-success disabled" : "")" @onclick="async() => await UpdateAsync(2)"><i class="ni ni-check-bold p-4"></i></button>
                                                <span class="text-bold">Đã thanh toán</span>
                                                <p>@HoaDon?.NgayThanhToan</p>
                                            </div>
                                            <div class="d-flex flex-column">
                                                <button class="btn me-2 @(HoaDon?.NgayNhan != null ? "btn-success disabled" : "")" @onclick="async() => await UpdateAsync(3)"><i class="ni ni-bag-17 p-4"></i></button>
                                                <span class="text-bold">Đã nhận hàng</span>
                                                <p>@HoaDon?.NgayNhan</p>
                                            </div>
                                        </div>
                                        <div class="row align-items-center text-end mt-2">
                                            <div class="col-12">
                                                <label class="col-form-label text-sm me-2 p-0 mb-2">Người nhận</label>
                                                <span class="text-bolder text-sm">@HoaDon?.TenNguoiNhan</span>
                                            </div>
                                            <div class="col-12">
                                                <label class="col-form-label text-sm me-2 p-0 mb-2">Số điện thoại</label>
                                                <span class="text-bolder text-sm">@HoaDon?.Sdt</span>
                                            </div>
                                            <div class="col-12">
                                                <label class="col-form-label text-sm me-2 p-0 mb-2">Địa chỉ</label>
                                                <span class="text-bolder text-sm">@HoaDon?.DiaChi</span>
                                            </div>
                                            <div class="col-12">
                                                <label class="col-form-label text-sm  me-2 p-0 mb-2">Tiền ship</label>
                                                <span class="text-bolder text-sm">@Helper.FormatMoney(HoaDon?.TienShip)</span>
                                            </div>
                                            <div class="col-12">
                                                <label class="col-form-label text-sm  me-2 p-0 mb-2">Khách phải trả</label>
                                                <span class="text-bolder text-sm">@Helper.FormatMoney(HoaDon?.TongTien + HoaDon?.TienShip) (@Helper.FormatMoney(HoaDon?.TienShip) tiền ship)</span>
                                            </div>
                                            <div class="col-12">
                                                <label class="col-form-label text-sm  me-2 p-0 mb-2">Trạng thái</label>
                                                <span class="text-bolder text-sm">@(HoaDon?.HinhThucThanhToans.Sum(c => c.TongTienThanhToan) + HoaDon?.TienShip < HoaDon?.TongTien ? "Chưa thanh toán đủ" : "Đã thanh toán")</span>
                                            </div>
                                        </div>
                                    </div>
                                }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {

    Uri Url = new Uri("https://localhost:7053/api/hoadon");

    [Parameter]
    public HoaDonModel? HoaDon { get; set; }

    async Task UpdateSale()
    {
        if(HoaDon != null)
        {
            if(HoaDon.TrangThai != Data.Enums.TrangThaiHoaDon.Done)
            {
                List<HoaDonModel> HoaDons = await Session.GetItemAsync<List<HoaDonModel>>("cart") ?? new List<HoaDonModel>();
                HoaDons.Add(HoaDon);
                await Session.SetItemAsync("cart", HoaDons);
                NavigationManager.NavigateTo("sale");
            }
            else
            {
                await Swal.FireAsync("Thông báo", "Hóa Đơn Đã Hoàn Thanh Không Thể Sửa", SweetAlertIcon.Error);
            }
        }
    }

    async Task Cancel()
    {
        if(HoaDon != null && HoaDon.TrangThai != Data.Enums.TrangThaiHoaDon.Done)
        {
            HoaDon.TrangThai = Data.Enums.TrangThaiHoaDon.Cancelled;
            HoaDon.NhanVien = null;
            var status = await HttpClient.PutAsJsonAsync<HoaDonModel>(Url.AddQuery("id", HoaDon.Id.ToString()), HoaDon);
            if (status.IsSuccessStatusCode)
            {
                await Swal.FireAsync("Thông báo", "Hủy Thành Công", SweetAlertIcon.Success);
                return;
            }
        }
        else
        {
            await Swal.FireAsync("Thông báo", "Không Thể Hủy Hóa Đơn Đã Hoàn Thành", SweetAlertIcon.Error);
        }
    }

    async Task UpdateAsync(int status)
    {
        if(HoaDon != null)
        {
            var thanhToan = HoaDon.HinhThucThanhToans.Sum(c => c.TongTienThanhToan) + HoaDon.TienShip < HoaDon.TongTien ? false : true ;
            switch (status)
            {
                case 1:
                    HoaDon.NgayGiaoHang = DateTime.Now;
                    break;
                case 2:
                    if (!thanhToan)
                    {
                        await Swal.FireAsync("Thông báo", "Chưa Thanh Toán Đủ", SweetAlertIcon.Error);
                        return;
                    }
                    HoaDon.NgayThanhToan = DateTime.Now;
                    break;
                case 3:
                    if (!thanhToan)
                    {
                        await Swal.FireAsync("Thông Báo", "Phải Thanh Toán Đủ Tiền Trước Khi Nhận", SweetAlertIcon.Error);
                        return;
                    }
                    HoaDon.NgayNhan = DateTime.Now;
                    HoaDon.NgayThanhToan = DateTime.Now;
                    if(HoaDon.NgayGiaoHang == null)
                    {
                        HoaDon.NgayGiaoHang = DateTime.Now;
                    }
                    break;
                default:
                    break;
            }
            if(HoaDon.NgayGiaoHang != null && HoaDon.NgayNhan != null && HoaDon.NgayThanhToan != null)
            {
                HoaDon.TrangThai = Data.Enums.TrangThaiHoaDon.Done;
            }
            HoaDon.NhanVien = null;
            await HttpClient.PutAsJsonAsync<HoaDonModel>(Url.AddQuery("id", HoaDon.Id.ToString()), HoaDon);
        }
    }
}